(function(n){var r=window.location.host,t,i;n.BoundaryFeatureLayer={defaultSettings:{defaultZise:{w:250,h:250},focusFillColor:[238,210,250,1],focusLineWidth:1,focusLineColor:[255,255,255,.8],defaultFillColor:[238,210,250,.8],defaultLineWidth:.5,defaultLineColor:[255,255,255,.5],defaultLayerIndex:0,featureLayerConfig:[{url:"https://water.tainan.gov.tw/tnwrbarcgis/rest/services/WRB/TNWRB_VectorMap/MapServer/0"+(window.getTokenPara?getTokenPara("?"):""),query:function(){return{where:"1=1",outFields:["nCity","CITYNAME"]}},nameField:"CITYNAME",mouseenter:function(){},mouseleave:function(){},click:function(){},load:undefined},{url:"https://water.tainan.gov.tw/tnwrbarcgis/rest/services/WRB/TNWRB_VectorMap/MapServer/1"+(window.getTokenPara?getTokenPara("?"):""),query:function(n){return n.attributes.nCity==67e3?{where:"nCity='"+n.attributes.nCity+"'",outFields:["TOWNNAME","nTown","nCity","CITYNAME"]}:(console.log(n.attributes.CITYNAME),!1)},nameField:"TOWNNAME",mouseenter:function(){},mouseleave:function(){},click:function(){},load:function(){}},{url:"https://water.tainan.gov.tw/tnwrbarcgis/rest/services/WRB/TNWRB_VectorMap/MapServer/2"+(window.getTokenPara?getTokenPara("?"):""),query:function(n){return{where:"nTown='"+n.attributes.nTown+"'",outFields:["FULL_","VillName","nTown","nCity"]}},nameField:"VillName",mouseenter:function(){},mouseleave:function(){},click:function(){}}]},customFilleColor:{TownId:"",Color:"red"}};t="BoundaryFeatureLayer";i=function(t,i){i&&(i.stopPropagation(),i.preventDefault());this.$element=n(t);this.settings=n.extend({},n.BoundaryFeatureLayer.defaultSettings);this.$__MapDiv=undefined;this.__boundarymap=undefined;this.__dialog=undefined;this.__guid=undefined;this.__clickFromLayer=!1;this.__onFocusGraphicSymbol=undefined;this.__loseFocusGraphicSymbol=undefined;this.__currentConfig=undefined;this.isInitCompleted=!1;this.graphicsUtils=undefined;this.webMercatorUtils=undefined};i.prototype={constructor:i,init:function(t){var i=this,r;n.extend(this.settings,t);this.$element.empty();this.$element.css("height","100%");this.__guid=geguid();this.$__MapDiv=n('<div id="map_'+this.__guid+'" style="width: 200px;height: 200px; padding: 0px; margin: 0px;"><\/div>');this.$element.append(this.$__MapDiv);this.$element.append('<label style="" class="btn  btn-sm prelayerincon" title="\u9ede\u64ca\u6216\u4efb\u610f\u9ede\u64ca\u908a\u754c\u5916\u53ef\u56de\u4e0a\u4e00\u5c64"><span class="glyphicon glyphicon-arrow-left" ><\/span><\/label>');n(".prelayerincon",this.$element).click(function(){i.__backToUplayer()});this.__showBackToUpLayerButton(this.settings.defaultLayerIndex!==0);i.$element.is(":visible")?i.__initMap():r=setInterval(function(){i.$element.is(":visible")&&(clearInterval(r),i.__initMap())},500)},__initMap:function(){this.$element.show_busyIndicator();var t=this;require(["esri/map","esri/layers/GraphicsLayer","esri/layers/FeatureLayer","esri/graphic","esri/geometry/Polygon","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/tasks/query","esri/geometry/webMercatorUtils","esri/graphicsUtils","esri/Color","dijit/TooltipDialog"],function(i,r,u,f,e,o,s,h,c,l){t.$element.hide_busyIndicator();t.graphicsUtils=l;t.webMercatorUtils=c;t.__boundarymap=new esri.Map("map_"+t.__guid,{logo:!1,autoResize:!1,showInfoWindowOnClick:!1,slider:!1,smartNavigation:!1,fadeOnZoom:!0});t.__boundarymap.spatialReference=t.settings.spatialReference;t.__boundarymap.on("load",n.proxy(t.__boundarymapLoaded,t));t.__onFocusGraphicSymbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(t.settings.focusLineColor),t.settings.focusLineWidth),new esri.Color(t.settings.focusFillColor));t.__loseFocusGraphicSymbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new esri.Color(t.settings.defaultLineColor),t.settings.defaultLineWidth),new esri.Color(t.settings.defaultFillColor));t.__currentConfig=t.settings.featureLayerConfig[t.settings.defaultLayerIndex];t.__initCurrentLayer();setTimeout(function(){if(t.$element.parents(".jsPanel").length>0)n(t.$element.parents(".jsPanel")[0]).on("resizestop",function(){t.__resizeMap()})})})},__initCurrentLayer:function(t){var i=this,r=undefined,u,e,f,o;t&&(u=i.__getParentConfig(i.__currentConfig)?t.attributes[i.__getParentConfig(i.__currentConfig).nameField]:undefined,u&&i.__currentConfig.layers&&n.each(i.__currentConfig.layers,function(){if(this.id===u)return r=this,console.log("from cache layer ...."+u),!1}));r?(i.__currentConfig.currentlayer=r,i.__resizeMap(!0),i.__currentConfig.load&&i.__currentConfig.load(r,t),i.__currentConfig.focus&&i.__currentConfig.focus()):(i.$element.show_busyIndicator(),i.__currentConfig.layers||(i.__currentConfig.layers=[]),r=new esri.layers.GraphicsLayer(u?{id:u}:{}),i.__currentConfig.layers.push(r),i.__boundarymap.addLayer(r),e=i.__currentConfig.query(t),f=new esri.tasks.Query,f.where=e.where,f.outFields=e.outFields,o=new esri.layers.FeatureLayer(i.__currentConfig.url,{outFields:["*"],mode:esri.layers.FeatureLayer.MODE_SNAPSHOT}),o.queryFeatures(f,function(u){r.hide();n.each(u.features,function(){i.__boundarymap.spatialReference=this.geometry.spatialReference;var n=new esri.Graphic(this.geometry,this.symbol,this.attributes);r.add(n);i.__loseFocusGraphic({graphic:n},n)});r.extent=i.graphicsUtils.graphicsExtent(r.graphics);r.on("mouse-over",function(n){i.__currentConfig.mouseenter&&i.__currentConfig.mouseenter(n.graphic);i.__onFocusGraphic(n,n.graphic,i.__currentConfig.nameField)});r.on("mouse-out",function(n){i.__currentConfig.mouseleave&&i.__currentConfig.mouseleave(n.graphic);i.__loseFocusGraphic(n,n.graphic)});r.on("click",function(n){i.__clickFromLayer=!0;var t=i.__getChildConfig(i.__currentConfig);i.__currentConfig.click&&i.__currentConfig.click(n.graphic);t&&t.query(n.graphic)&&(r.hide(),i.__currentConfig=t,i.__initCurrentLayer(n.graphic),i.__showBackToUpLayerButton(!0))});i.__currentConfig.currentlayer=r;i.__resizeMap(!0);i.__currentConfig.load&&i.__currentConfig.load(r,t);i.__currentConfig.focus&&i.__currentConfig.focus()}))},__resizeMap:function(n){if(this.$element.is(":visible")){var t=this;t.$__MapDiv.width("100%").height("100%");t.__boundarymap.resize(!0);t.__boundarymap.setExtent(t.__currentConfig.currentlayer.extent).then(function(){t.__currentConfig.currentlayer.show();n&&setTimeout(function(){t.$element.hide_busyIndicator()},100)})}},__showBackToUpLayerButton:function(t){t?n(".prelayerincon",this.$element).show():n(".prelayerincon",this.$element).hide()},__backToUplayer:function(){var t=this,n=this.__getParentConfig(this.__currentConfig);n&&(n.focus&&n.focus(),this.$element.show_busyIndicator(),this.__currentConfig.currentlayer.hide(),this.__currentConfig=n,n.currentlayer?this.__boundarymap.setExtent(n.currentlayer.extent).then(function(){t.__currentConfig.currentlayer.show();setTimeout(function(){t.$element.hide_busyIndicator()},100)}):(t.$element.hide_busyIndicator(),t.__initCurrentLayer()),this.settings.featureLayerConfig[0].url===this.__currentConfig.url&&this.__showBackToUpLayerButton(!1))},__boundarymapLoaded:function(){var n=this;this.__boundarymap.disableDoubleClickZoom();this.__boundarymap.disablePan();this.__boundarymap.disableScrollWheelZoom();this.__boundarymap.on("click",function(){n.__clickFromLayer||(n.__backToUplayer(),console.log("map click"));n.__clickFromLayer=!1});this.__dialog=new dijit.TooltipDialog({style:"position:absolute; width:auto;opacity:0.5;"});dojo.style(this.__dialog.connectorNode,"display","none");this.__dialog.startup()},__getChildConfig:function(t){var i=this,r=undefined;return n.each(i.settings.featureLayerConfig,function(n){if(this.url===t.url)return n!=i.settings.featureLayerConfig.length-1&&(r=i.settings.featureLayerConfig[n+1]),!1}),r},__getParentConfig:function(t){var i=this,r=undefined;return n.each(i.settings.featureLayerConfig,function(n){if(this.url===t.url)return n!=0&&(r=i.settings.featureLayerConfig[n-1]),!1}),r},__onFocusGraphic:function(n,t,i){this.__dialog&&(this.__boundarymap.setMapCursor("pointer"),n.graphic.customSymbol?n.graphic.symbol.outline.width=n.graphic.symbol.outline.width*2:n.graphic.symbol=this.__onFocusGraphicSymbol,n.graphic.draw(),i?this.__dialog.setContent(n.graphic.attributes[i]):this.__dialog.setContent(n.graphic.attributes.name),!dojo.isIE&&n.graphic&&n.graphic.getDojoShape().moveToFront(),dijit.popup.open({popup:this.__dialog,around:this.domNode,orient:["below-centered","above-centered"],x:n.pageX+3,y:n.pageY}))},__loseFocusGraphic:function(n){this.__dialog&&(n.graphic.customSymbol?n.graphic.symbol.outline.width=n.graphic.symbol.outline.width/2:n.graphic.symbol=n.graphic.customsymbol?n.graphic.customsymbol:this.__loseFocusGraphicSymbol,n.graphic.draw(),this.__boundarymap.setMapCursor("default"),dijit.popup.close(this.__dialog))}};n.fn[t]=function(r){var f,u;if(this.data(t)instanceof i||this.data(t,new i(this[0])),u=this.data(t),typeof r=="undefined"||typeof r=="object")return typeof u.init=="function"&&u.init(r),this.instance=u,this;if(typeof r=="string"&&typeof u[r]=="function")return f=Array.prototype.slice.call(arguments,1),u[r].apply(u,f);n.error("Method "+r+" does not exist on jQuery."+t)}})(jQuery);