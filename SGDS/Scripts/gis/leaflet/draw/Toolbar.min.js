L.Toolbar=L.Class.extend({initialize:function(n){L.setOptions(this,n);this._modes={};this._actionButtons=[];this._activeMode=null;var t=L.version.split(".");parseInt(t[0],10)===1&&parseInt(t[1],10)>=2?L.Toolbar.include(L.Evented.prototype):L.Toolbar.include(L.Mixin.Events)},enabled:function(){return this._activeMode!==null},disable:function(){this.enabled()&&this._activeMode.handler.disable()},addToolbar:function(n){var r=L.DomUtil.create("div","leaflet-draw-section"),u=0,f=this._toolbarClass||"",i=this.getModeHandlers(n),t;for(this._toolbarContainer=L.DomUtil.create("div","leaflet-draw-toolbar leaflet-bar"),this._map=n,t=0;t<i.length;t++)i[t].enabled&&this._initModeHandler(i[t].handler,this._toolbarContainer,u++,f,i[t].title);if(u)return this._lastButtonIndex=--u,this._actionsContainer=L.DomUtil.create("ul","leaflet-draw-actions"),r.appendChild(this._toolbarContainer),r.appendChild(this._actionsContainer),r},removeToolbar:function(){var n,t,i;for(n in this._modes)this._modes.hasOwnProperty(n)&&(this._disposeButton(this._modes[n].button,this._modes[n].handler.enable,this._modes[n].handler),this._modes[n].handler.disable(),this._modes[n].handler.off("enabled",this._handlerActivated,this).off("disabled",this._handlerDeactivated,this));for(this._modes={},t=0,i=this._actionButtons.length;t<i;t++)this._disposeButton(this._actionButtons[t].button,this._actionButtons[t].callback,this);this._actionButtons=[];this._actionsContainer=null},_initModeHandler:function(n,t,i,r,u){var f=n.type;this._modes[f]={};this._modes[f].handler=n;this._modes[f].button=this._createButton({type:f,title:u,className:r+"-"+f,container:t,callback:this._modes[f].handler.enable,context:this._modes[f].handler});this._modes[f].buttonIndex=i;this._modes[f].handler.on("enabled",this._handlerActivated,this).on("disabled",this._handlerDeactivated,this)},_detectIOS:function(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream},_createButton:function(n){var t=L.DomUtil.create("a",n.className||"",n.container),i=L.DomUtil.create("span","sr-only",n.container),r;t.href="#";t.appendChild(i);n.title&&(t.title=n.title,i.innerHTML=n.title);n.text&&(t.innerHTML=n.text,i.innerHTML=n.text);r=this._detectIOS()?"touchstart":"click";L.DomEvent.on(t,"click",L.DomEvent.stopPropagation).on(t,"mousedown",L.DomEvent.stopPropagation).on(t,"dblclick",L.DomEvent.stopPropagation).on(t,"touchstart",L.DomEvent.stopPropagation).on(t,"click",L.DomEvent.preventDefault).on(t,r,n.callback,n.context);return t},_disposeButton:function(n,t){var i=this._detectIOS()?"touchstart":"click";L.DomEvent.off(n,"click",L.DomEvent.stopPropagation).off(n,"mousedown",L.DomEvent.stopPropagation).off(n,"dblclick",L.DomEvent.stopPropagation).off(n,"touchstart",L.DomEvent.stopPropagation).off(n,"click",L.DomEvent.preventDefault).off(n,i,t)},_handlerActivated:function(n){this.disable();this._activeMode=this._modes[n.handler];L.DomUtil.addClass(this._activeMode.button,"leaflet-draw-toolbar-button-enabled");this._showActionsToolbar();this.fire("enable")},_handlerDeactivated:function(){this._hideActionsToolbar();L.DomUtil.removeClass(this._activeMode.button,"leaflet-draw-toolbar-button-enabled");this._activeMode=null;this.fire("disable")},_createActions:function(n){for(var u=this._actionsContainer,i=this.getActions(n),s=i.length,f,o,t,r=0,e=this._actionButtons.length;r<e;r++)this._disposeButton(this._actionButtons[r].button,this._actionButtons[r].callback);for(this._actionButtons=[];u.firstChild;)u.removeChild(u.firstChild);for(t=0;t<s;t++)"enabled"in i[t]&&!i[t].enabled||(f=L.DomUtil.create("li","",u),o=this._createButton({title:i[t].title,text:i[t].text,container:f,callback:i[t].callback,context:i[t].context}),this._actionButtons.push({button:o,callback:i[t].callback}))},_showActionsToolbar:function(){var n=this._activeMode.buttonIndex,t=this._lastButtonIndex,i=this._activeMode.button.offsetTop-1;this._createActions(this._activeMode.handler);this._actionsContainer.style.top=i+"px";n===0&&(L.DomUtil.addClass(this._toolbarContainer,"leaflet-draw-toolbar-notop"),L.DomUtil.addClass(this._actionsContainer,"leaflet-draw-actions-top"));n===t&&(L.DomUtil.addClass(this._toolbarContainer,"leaflet-draw-toolbar-nobottom"),L.DomUtil.addClass(this._actionsContainer,"leaflet-draw-actions-bottom"));this._actionsContainer.style.display="block";this._map.fire(L.Draw.Event.TOOLBAROPENED)},_hideActionsToolbar:function(){this._actionsContainer.style.display="none";L.DomUtil.removeClass(this._toolbarContainer,"leaflet-draw-toolbar-notop");L.DomUtil.removeClass(this._toolbarContainer,"leaflet-draw-toolbar-nobottom");L.DomUtil.removeClass(this._actionsContainer,"leaflet-draw-actions-top");L.DomUtil.removeClass(this._actionsContainer,"leaflet-draw-actions-bottom");this._map.fire(L.Draw.Event.TOOLBARCLOSED)}});