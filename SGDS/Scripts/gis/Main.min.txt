(function(n){"use strict";var t="temp__",i=function(t,i){i&&(i.stopPropagation(),i.preventDefault());this.$element=n(t);this.settings={}};i.prototype={constructor:i,init:function(i){n.extend(this.settings,i);console.log(t+" init")}};n.fn[t]=function(r){this.each(function(){var f,u=n(this).data(t);if(u||(n(this).data(t,new i(this)),u=n(this).data(t)),typeof r=="undefined"||typeof r=="object")typeof u.init=="function"&&u.init(r);else{if(typeof r=="string"&&typeof u[r]=="function")return f=Array.prototype.slice.call(arguments,1),u[r].apply(u,f);n.error("Method "+r+" does not exist on jQuery."+t)}})}})(jQuery);var whatMap=function(n){return n.overlayMapTypes?"google":"arcgis"};(function(n){"use strict";function f(n){var t=document.getElementsByTagName("script"),i;if(t&&t.length>0)for(i in t){if(t[i].src&&t[i].src.match(new RegExp(n+"\\.js$")))return t[i].src.replace(new RegExp("(.*)"+n+"\\.js$"),"$1");if(t[i].src&&t[i].src.match(new RegExp(n+".min\\.js$")))return t[i].src.replace(new RegExp("(.*)"+n+".min\\.js$"),"$1")}}var i=function(t,i){var u,r;if(t)for(u=0,r=0;r<t.length;r++)n.getScript(t[r],function(){u++;t.length==u&&i()})},r,u,t;n.AppConfigOptions=n.extend({script:{},default_loading_icon:undefined},n.AppConfigOptions,!0);n.AppConfigOptions.script.gispath||(n.AppConfigOptions.script.gispath=f("gis/Main")+"gis");n.AppConfigOptions.default_loading||(n.AppConfigOptions.default_loading={icon:n.AppConfigOptions.script.gispath+"/images/loading/loading_black.gif",size:"0.9em"});console.log("gis script path:"+n.AppConfigOptions.script.gispath);n.AppConfigOptions.def={};n.AppConfigOptions.def.typh={name:"typh",js:"/ext/typh/Typh.js"};n.AppConfigOptions.def.cloud={name:"cloud",js:"/ext/cloud/Cloud.js"};n.AppConfigOptions.def.drawtool={name:"gisdrawtool",js:"/ext/draw/Drawtool.js"};n.AppConfigOptions.def.mapBaseLayer={name:"MapBaseLayer",js:"/ext/baselayer/MapBaseLayer.js"};n.AppConfigOptions.def.coordinateInfo={name:"CoordinateInfo",js:"/ext/info/CoordinateInfo.js"};n.AppConfigOptions.def.export={name:"ExportMap",js:"/ext/export/ExportMap.js"};n.AppConfigOptions.def.basepinctrl={name:"BasePinCtrl",js:"/ext/meter/BasePinCtrl.js"};n.AppConfigOptions.def.pinctrl={name:"PinCtrl",js:"/ext/meter/PinCtrl.js"};n.AppConfigOptions.def.polygonctrl={name:"PolygonCtrl",js:"/ext/meter/PolygonCtrl.js"};n.AppConfigOptions.def.polylinectrl={name:"PolylineCtrl",js:"/ext/meter/PolylineCtrl.js"};n.AppConfigOptions.def.kmlctrl={name:"KmlCtrl",js:"/ext/meter/KmlCtrl.js"};n.AppConfigOptions.def.waterctrl={name:"WaterCtrl",js:"/ext/meter/WaterCtrl.js"};n.AppConfigOptions.def.rainctrl={name:"RainCtrl",js:"/ext/meter/RainCtrl.js"};n.AppConfigOptions.def.cctvctrl={name:"CctvCtrl",js:"/ext/meter/CctvCtrl.js"};n.AppConfigOptions.def.boundary={name:"Boundary",js:"/ext/boundary/Boundary.js"};n.AppConfigOptions.def.boundaryMap={name:"BoundaryMap",js:"/ext/boundary/BoundaryMap.js"};n.AppConfigOptions.def.boundaryLayer={name:"BoundaryLayer",js:"/ext/boundary/BoundaryLayer.js"};n.AppConfigOptions.def.boundaryFeatureLayer={name:"BoundaryFeatureLayer",js:"/ext/arcgis/BoundaryFeatureLayer.js"};n.AppConfigOptions.def.localKml={name:"LocalKml",js:"/ext/kml/LocalKml.js"};n.AppConfigOptions.def.basePosition={name:"BasePosition",js:"/ext/position/BasePosition.js"};n.AppConfigOptions.def.districtPosition={name:"DistrictPosition",js:"/ext/position/DistrictPosition.js"};n.AppConfigOptions.def.addressGeocode={name:"addressGeocode",js:"/ext/geocode/AddressGeocode.js"};n.AppConfigOptions.require={};n.AppConfigOptions.require.request=function(t,r){var u=[],e=function(){u.length>0?i(u,r):r()},f;n.each(t,function(){this!==undefined&&(n.fn[this.name]||(this.js===n.AppConfigOptions.def.basepinctrl.js?f=n.AppConfigOptions.script.gispath+this.js:u.push(n.AppConfigOptions.script.gispath+this.js)))});f?i([f],e):e()};n.AppConfigOptions.require.all=function(t){n.AppConfigOptions.def.all=[];for(var i in n.AppConfigOptions.def)if(i!=="all"){if(i=="boundary"&&window.boundary&&window.boundary.PolygonBoundary)continue;n.AppConfigOptions.def.all.push(n.AppConfigOptions.def[i])}n.AppConfigOptions.require.request(n.AppConfigOptions.def.all,t)};n.MapBaseLayerDefaultSettings={layerid:"basemaplayer",tiles:{MAP_TYPE_ROADMAP:{id:"google_roadmap",name:"街圖",type:"WebTiledLayer",url:"http://${subDomain}.googleapis.com/vt?lyrs=m@262000000&src=apiv3&hl=zh-TW&x=${col}&y=${row}&z=${level}&style=47,37%7Csmartmaps",options:{subDomains:["mt0","mt1","mt2","mt3"]}},MAP_TYPE_SATELLITE_HYBRID:{id:"google_hybrid",name:"衛星",type:"WebTiledLayer",url:"http://${subDomain}.google.com/vt/lyrs=y&hl=zh-TW&x=${col}&y=${row}&z=${level}&s=Galile",options:{subDomains:["mt0","mt1","mt2","mt3"]}},MAP_TYPE_PHYSICAL_HYBRID:{id:"google_terrain",name:"地形",type:"WebTiledLayer",url:"http://${subDomain}.google.com.tw/vt/lbw/lyrs=p&hl=zh-TW&x=${col}&y=${row}&z=${level}&s=Gali",options:{subDomains:["khm0","khm1","khm2","khm3"]}}},ext:{TGOS:{"通用版電子地圖":{id:"tgos",name:"通用版電子地圖",type:"WebTiledLayer",url:"http://${subDomain}gis.sinica.edu.tw/tgos/file-exists.php?img=NLSCMAP_W-png-${level}-${col}-${row}",options:{subDomains:["","",""]}},"TGOS電子地圖":{id:"TGOSMAP_W",name:"TGOS電子地圖",type:"WebTiledLayer",url:"http://${subDomain}gis.sinica.edu.tw/tgos/file-exists.php?img=TGOSMAP_W-png-${level}-${col}-${row}",options:{subDomains:["","",""]}},"福衛二號混合圖":{id:"ROADMAP_W",name:"福衛二號混合圖",type:"WebTiledLayer",url:"http://${subDomain}gis.sinica.edu.tw/tgos/file-exists.php?img=ROADMAP_W-png-${level}-${col}-${row}",options:{subDomains:["","",""]}},"福衛二號影像":{id:"F2IMAGE_W",name:"福衛二號影像",type:"WebTiledLayer",url:"http://${subDomain}gis.sinica.edu.tw/tgos/file-exists.php?img=F2IMAGE_W-png-${level}-${col}-${row}",options:{subDomains:["","",""]}},"地形暈渲混合圖":{id:"HILLSHADE_W",name:"地形暈渲混合圖",type:"WebTiledLayer",url:"http://${subDomain}gis.sinica.edu.tw/tgos/file-exists.php?img=HILLSHADEMIX_W-png-${level}-${col}-${row}",options:{subDomains:["","",""]}},"地形暈渲圖":{id:"HILLSHADE_W",name:"地形暈渲圖",type:"WebTiledLayer",url:"http://${subDomain}gis.sinica.edu.tw/tgos/file-exists.php?img=HILLSHADE_W-png-${level}-${col}-${row}",options:{subDomains:["","",""]}},"路網數值圖":{id:"MOTCMAP_W",name:"路網數值圖",type:"WebTiledLayer",url:"http://${subDomain}gis.sinica.edu.tw/tgos/file-exists.php?img=MOTCMAP_W-png-${level}-${col}-${row}",options:{subDomains:["","",""]}}}},defaultSettings:{map:null,ctrlMode:"radio",defaultLayer:"街圖",initEvent:null}};n.menuctrl={eventKeys:{popu_init_before:"popu-init-event-before",popu_init_after:"popu-init-event-after",ctrl_show_change:"showchange",init_ctrl_menu_completed:"init-menu-init_ctrl_menu_completed"}};n.checkFunctionMenu=function(t,i){if(i&&i!="*"){var r=n(t+" [data-function-id]");n.each(r,function(){var t=n(this),r=t.attr("data-function-id");t.addClass("none-auth-function");n.each(i,function(){if(r==this.Id)return t.removeClass("none-auth-function"),!1})});n(t+" .none-auth-function").remove();n.each(n(t+" ul:not(:has(*))"),function(){n(this).parent("li").length>0&&n(this).parent("li").remove()})}};n.initGisMenu=function(t){var c=n(".popu-ctrl-container"),l=0,i=t.indexOf(".")===0?n(t):n("#"+t),e,a;n.each(n(".popu-ctrl-menu"),function(){c.find(n(this).attr("href")).addClass("popu-ctrl-content")});e=function(){var t=n(".tools-group-ctrl",i);n.each(t,function(){var i=n(this),r,t;i.find(".caret:first").remove();r=n(".popu-ctrl-container");t=n("+ul",i);t.addClass("tools-group-panel").removeClass("dropdown-menu").appendTo(r);t.attr("id")||t.attr("id",geguid());i.attr("href","#"+t.attr("id")).addClass("posit-ctrl-menu");n.each(n(">li>a",t),function(){var t=n(this);t.addClass("tools-member-ctrl");t.attr("title",t.html());t.html("");n('<span class="glyphicon '+t.attr("data-glyphicon")+'"><\/span>').appendTo(t)})})};e();n(".popu-ctrl-menu").click(function(t){var h=n(this),e,c,a,r,v;if(t.preventDefault(),n(".navbar-collapse",i).removeClass("in").addClass("collapse"),e=n(n(this).attr("href")),e.show(),t.clientX&&u(h,{clientX:t.clientX,clientY:t.clientY}),e.length>0&&n(this).attr("popu-target")==undefined){e.show();e.trigger(n.menuctrl.eventKeys.popu_init_before);c=(new Date).getTime();e.css("min-height","100%");a=h.attr("data-theme")?h.attr("data-theme"):"gdark";r=n(".popu-ctrl-container").jsPanel({id:c+"",title:n(this).context.innerHTML+(n(this).hasClass("tools-member-ctrl")?" "+n(this).attr("title"):""),theme:a,contentBG:{padding:"0 3px 3px 3px"},size:{width:"",height:"auto"},overflow:"auto",draggable:{stop:function(t){n(t.target).css("opacity","")},handle:".jsPanel-hdr-l"},position:n.isSupportLocalStorage()?{top:t.clientY,left:t.clientX}:{top:i.height(),left:f()?n(".popu-ctrl-container .jsPanel").length*15:""},controls:{buttons:"all",iconfont:"bootstrap"},content:e}).addClass("popu-ctrl").addClass("col-md-2").on("onjspanelloaded",function(){});e.attr("id")&&r.addClass("jsPanel-"+e.attr("id"));r.on("resizestop",function(){u(h,{width:r.width(),height:r.height()})});r.on("dragstop",function(){u(h,{top:r.position().top,left:r.position().left})});n(this).attr("data-default-width")&&r.attr("data-width",n(this).attr("data-default-width"));n(this).attr("data-default-height")&&r.attr("data-height",n(this).attr("data-default-height"));n(this).attr("data-default-top")&&r.attr("data-top",n(this).attr("data-default-top")+"px");n(this).attr("data-default-left")&&r.attr("data-left",n(this).attr("data-default-left")+"px");n(this).attr("popu-target",c);n(".jsPanel-content",r).css("padding","0 2px 2px 2px");n(".jsPanel-hdr-r .jsPanel-hdr-r-btn-close",r).unbind("click");n(".jsPanel-hdr-r .jsPanel-hdr-r-btn-close",r).click(function(){o(h,r)});n(".jsPanel-hdr-r-btn-max",r).hide();n(".jsPanel-hdr-r-btn-min",r).click(function(){n(".jsPanel-hdr-r-btn-max",r).show();n(".jsPanel-hdr-r-btn-min",r).hide();n(".jsPanel-hdr-r .jsPanel-hdr-r-btn-close",r).hide()});n(".jsPanel-hdr-r-btn-max",r).click(function(){n(".jsPanel-hdr-r-btn-max",r).hide();n(".jsPanel-hdr-r-btn-min",r).show();n(".jsPanel-hdr-r .jsPanel-hdr-r-btn-close",r).show()});r.mouseenter(function(){r.front()});s();e.trigger(n.menuctrl.eventKeys.popu_init_after);r.hide()}l++;v=n("#"+n(this).attr("popu-target"));o(h,v)}).on("setActive",function(t,i){var r=n(t.target);i&&!r.hasClass("selected")?r.trigger("click"):!i&&r.hasClass("selected")&&r.trigger("click")});n(".posit-ctrl-menu").click(function(t){var e=n(this),r,f;t.preventDefault();n(".navbar-collapse",i).removeClass("in").addClass("collapse");r=n(n(this).attr("href"));r.length>0&&n(this).attr("popu-target")==undefined&&(r.trigger(n.menuctrl.eventKeys.popu_init_before),r.hide(),n(this).attr("popu-target",(new Date).getTime()),r.trigger(n.menuctrl.eventKeys.popu_init_after));f=r.attr("data-display-direction");u(e,{show:!r.is(":visible")});"up-down"===f?r.is(":hidden")?r.slideDown(500):r.slideUp(500):r.toggle("slide",{direction:f?f:"left",easing:"easeInOutBack"},500);r.mouseenter(function(){var t=0;n(".jsPanel").each(function(){n(this).zIndex()>t&&(t=n(this).zIndex())});r.css("z-index",t+1)});e.toggleClass("selected")}).on("setActive",function(t,i){var r=n(t.target);i&&!r.hasClass("selected")?r.trigger("click"):!i&&r.hasClass("selected")&&r.trigger("click")});n(".navbar-header",i).before(n('<div class="close-mainmenu"><span title="隱藏" class=" glyphicon glyphicon-export"><\/span><\/div>'));a=n(".glyphicon.glyphicon-export",i);n(".close-mainmenu",i).click(function(){i.toggle("slide",{direction:"top",easing:"easeInOutCubic"},500)});i.after('<div style="right:0px;position: absolute;z-index:'+(i.css("z-index")-1)+';"><button  class=" show-mainmenu" ><span title="功能選單" class="glyphicon glyphicon-align-justify"><\/span><\/button><\/div>');n(".show-mainmenu").click(function(){i.toggle("slide",{direction:"top",easing:"easeInOutBack"},500)});n(window).resize(function(){s()});var v=0,o=function(t,r){var o,s,e;if(t.toggleClass("selected"),o=t.hasClass("selected"),f()&&n.isSupportLocalStorage()){r.show();r.parents("#jsPanel-min-container").length==0?(s=r.position(),e=h(t),o?(e&&e.top?r.css("top",e.top+"px"):r.css("top",(i.is(":visible")?i.height():10)+"px"),e&&e.left?r.css("left",e.left+"px"):r.css("left",v++*40+"px")):(e&&e.clientY&&r.css("top",e.clientY+"px"),e&&e.clientX&&r.css("left",e.clientX+"px"))):n(".jsPanel-hdr-r-btn-max",r).trigger("click");r.addClass("switch").toggleClass("selected");r.one("transitionend oTransitionEnd otransitionend MSTransitionEnd",function(){setTimeout(function(){r.removeClass("switch");t.hasClass("selected")||r.hide()})});u(t,{show:o})}else r.toggleClass("selected"),r.toggle("slide",{direction:"left",duration:300,easing:"easeOutQuad"},y),u(t,{show:!r.is(":visible")});t.trigger(n.menuctrl.eventKeys.ctrl_show_change,o)},s=function(){var t=n(".popu-ctrl-container .popu-ctrl"),r;t.length>0&&(f()?n.each(t,function(t,i){var r=n(i),u,f;r.css("position","absolute");r.attr("data-width")&&(r.css("width",n(i).attr("data-width")),n(i).attr("data-width",""));r.attr("data-height")&&(r.css("height",n(i).attr("data-height")),n(i).attr("data-height",""));r.attr("data-top")!==undefined&&(u=n(i).attr("data-top").replace("px",""),f=n(i).attr("data-left").replace("px",""),window.outerHeight-u<70&&(u=window.outerHeight-70),window.outerWidth-f<200&&(f=window.outerWidth-200),n(i).attr("data-top",""),n(i).attr("data-left",""),r.css("top",u+"px"),r.css("left",f+"px"))}):(r=i.height(),n.each(t,function(t,i){var u=n(i),f;u.css("position")!="relative"&&(u.attr("data-top",n(i).css("top")),u.attr("data-left",n(i).css("left")),f=u.attr("style"),(u.attr("style")+"").indexOf("width:")>=0&&(u.attr("data-width",n(i).css("width")),u.css("width","auto")),u.css("top",r),u.css("left","0px"),u.css("position","relative"))})))},r;try{r={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return r.Android()||r.BlackBerry()||r.iOS()||r.Opera()||r.Windows()}}}catch(w){}var f=function(){return n(".navbar-header .navbar-toggle",i).is(":hidden")&&(r?!r.any():!1)},y=function(){n(this).hasClass("minimized")&&(n(this).css("display","block"),n(".jsPanel-hdr-r-btn-max",n(this)).trigger("click"));n(".jsPanel-hdr-r-btn-max",n(this)).hide();p()},p=function(){var i=[],t,r;for(n.each(n(".jsPanel.minimized"),function(t,r){n(r).css("display")!=="none"&&i.push(r)}),t=0;t<i.length;t++)r=t*150+"px",n(i[t]).animate({left:r})},u=function(t,i){n.localCache.set(t.text()?t.text():t.attr("title"),n.extend(n.localCache.get(t),i))},h=function(t){return n.localCache.get(t.text()?t.text():t.attr("title"))};return setTimeout(function(){i.attr("data-ctrl-cache")==="true"&&n.each(n(".popu-ctrl-menu,.posit-ctrl-menu "),function(){var t=h(n(this)),i;if(t)for(i in t)t[i]!==undefined&&n(this).attr("data-default-"+i,t[i])});n(".popu-ctrl-menu[data-default-show=true],.posit-ctrl-menu[data-default-show=true]",i).trigger("click");n(".tools-group-panel .popu-ctrl-menu[data-default-show=true],.tools-group-panel .posit-ctrl-menu[data-default-show=true]").trigger("click");i.trigger(n.menuctrl.eventKeys.init_ctrl_menu_completed)},800),this};n.kmlhelper=function(t){var i={autoPolygonIndextoLower:!0,onLoaded:undefined};n.extend(i,t);i.map!=undefined&&require(["esri/layers/KMLLayer"],function(r){var u=new r(encodeURI(t.kmlurl),{id:i.layerid});if(i.map.addLayer(u),i.autoPolygonIndextoLower===!0)n.setPolygonIndextoLower(i.map,u,i.onLoaded);else if(i.onLoaded)u.on("load",function(){if(i.onLoaded)i.onLoaded(u)})})};n.parserStringToObject=function(t,i,r){var u={};return n.each(t.split(i),function(n,t){if(t.trim()){var i=t.split(r);i.length!=0&&(u[i[0].trim()]=i[1].trim())}}),u};r=0;n.setPolygonIndextoLower=function(t,i,u){require(["dojo/_base/connect","esri/symbols/SimpleMarkerSymbol"],function(f){var e=i.__proto__?i.__proto__.declaredClass:i.declaredClass,o,s,h;if(e==="esri.layers.KMLLayer"){i.on("load",function(r){var f=r.layer.getLayers(),e=0;n.each(f,function(r,o){n.setPolygonIndextoLower(t,o,function(){e++;e===f.length&&u&&u(i)})})});i.on("error",function(n){u(i,n,"error")})}else e==="esri.layers.FeatureLayer"?(o=n.parseJSON(i._json),o.featureSet.features.length>0?(s=Boolean(o.featureSet.features[0].attributes.visibility),s?h=f.connect(i,"onUpdate",function(){f.disconnect(h);i.graphics.length>0&&i.graphics[0].geometry.type==="polygon"&&(t.reorderLayer(i,r),r++);u&&u(i);console.log(i.id+">>onload>")}):u&&u(i)):u&&u(i)):e==="esri.layers.MapImageLayer"&&u&&u(i)})};n.loadKmllayer=function(t,i,r,u,f,e){var h=null,s=i,o;try{localStorage&&u&&(o=JSON.parse(localStorage.getItem(s)),o&&(o.version==f?h=o.data:(localStorage.removeItem(s),console.log(r+" reomve old localStorage ;old version:"+o.version+"  new version:"+f))));localStorage&&!u&&(localStorage.removeItem(s),console.log(r+" not use localStorage ;"))}catch(c){}h?(require(["esri/layers/FeatureLayer"],function(n){var i=new n(h,{id:r+"_0"});t.addLayer(i);e(i)}),console.log(r+" use localStorage ;version:"+f)):(n.kmlhelper({map:t,layerid:r,kmlurl:i,onLoaded:function(n){var t=n.getLayers()[0],i;if(!dojo.isAndroid&&!dojo.isIos&&localStorage&&u&&t.toJson)try{i=t.toJson();localStorage.setItem(s,JSON.stringify({version:f,"data-size":JSON.stringify(i).length,data:i}))}catch(r){console.log(r)}e(t)}}),console.log(r+" use kml"))};n.autoOrderLayer=function(n){var r=0,i=0,t=0,f=function(u){n.reorderLayer(u,r);r++;i++;t++},e=function(r){n.reorderLayer(r,i);i++;t++},o=function(i){n.reorderLayer(i,t);t++},u=function(n){"point|multipoint ".indexOf(n.graphics[0].geometry.type)>=0?o(n):"polyline".indexOf(n.graphics[0].geometry.type)>=0?e(n):"polygon|extent".indexOf(n.graphics[0].geometry.type)>=0&&f(n)};n.on("layer-add",function(n){if(n.layer.graphics)if(n.layer.graphics.length>0)u(n.layer);else var t=n.layer.on("graphic-add",function(){u(n.layer);t.remove()})})};n.fn.gis_layer_opacity_slider=function(t){function r(){i.setOpacity&&i.setOpacity(u.slider("value")/100);f&&i.map.getLayer(i.layerid).setOpacity(u.slider("value")/100)}var i={map:null,layerid:undefined,min:10,max:100,value:95},u=this,f=!1,e,o;n.extend(i,t);i.map==null&&alert("map is null");u.slider({range:"min",max:i.max,min:i.min,value:i.value,slide:r,change:r});whatMap(i.map)==="arcgis"&&(e=i.map._layers[i.layerid],e?f=!0:o=i.map.on("layer-add",function(n){n.layer.id==i.layerid&&(f=!0,r())}));r()};u=function(){setTimeout(function(){},1)};t=[];n.fn.jsPanel||t.push(n.AppConfigOptions.script.gispath+"/jspanel/jquery.jspanel-1.10.0.js");window.helper&&window.helper.loaded||t.push(n.AppConfigOptions.script.gispath+"/helper.js");t.length>0?i(t,function(){n(".navbar").length>0&&u()}):n(".navbar").length>0&&u()})(jQuery);